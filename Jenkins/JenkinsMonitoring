pipeline {
    agent any
    environment {
        CLUSTER_NAME = 'app-clus'
        REGION       = 'us-west-2'
        APP_NAME     = 'k8ui'
        MONITOR_INGRESS_FILE = 'K8s/Ingress/monitoring/monitoring-ingress.yaml'
        ARGOCD_INGRESS_FILE  = 'K8s/Ingress/argo/argocd-ingress.yaml'
    }

    stages {

        stage('Update kubeconfig') {
            steps {
                script {
                    withAWS(credentials: 'aws-creds', region: REGION) {
                        echo "üîÑ Updating kubeconfig for EKS cluster '${CLUSTER_NAME}'..."
                        sh """
                            aws eks update-kubeconfig --name ${CLUSTER_NAME} --region ${REGION} --alias ${CLUSTER_NAME}
                            kubectl config use-context ${CLUSTER_NAME}
                            kubectl get nodes --context=${CLUSTER_NAME}
                        """
                    }
                }
            }
        }

        stage('Patch CNI Plugin (Conditional)') {
            steps {
                script {
                    withAWS(credentials: 'aws-creds', region: REGION) {
                        echo "üîç Checking current AWS CNI version..."
                        def currentCNI = sh(
                            script: "kubectl -n kube-system get ds aws-node -o jsonpath='{.spec.template.spec.containers[0].image}'",
                            returnStdout: true
                        ).trim()

                        def desiredVersion = "v1.19.5"

                        if (!currentCNI.contains(desiredVersion)) {
                            echo "‚öôÔ∏è Patching CNI to ${desiredVersion} (current: ${currentCNI})"
                            sh """
                                kubectl apply -f https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/${desiredVersion}/config/master/aws-k8s-cni.yaml
                            """
                        } else {
                            echo "‚úÖ CNI already at desired version: ${currentCNI}"
                        }
                    }
                }
            }
        }

        stage('Install/Upgrade Ingress Controller') {
            steps {
                script {
                    withAWS(credentials: 'aws-creds', region: REGION) {
                        echo 'üöÄ Installing/Upgrading NGINX Ingress Controller...'
                        sh '''
                            helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx || true
                            helm repo update

                            if helm ls -n ingress-nginx | grep -q ingress-nginx; then
                                echo "üîÑ Upgrading existing Ingress Controller..."
                                helm upgrade ingress-nginx ingress-nginx/ingress-nginx \
                                  --namespace ingress-nginx \
                                  --set controller.service.type=LoadBalancer \
                                  --set controller.publishService.enabled=true \
                                  --set controller.scope.enabled=false
                            else
                                echo "üöÄ Installing new Ingress Controller..."
                                helm install ingress-nginx ingress-nginx/ingress-nginx \
                                  --namespace ingress-nginx --create-namespace \
                                  --set controller.service.type=LoadBalancer \
                                  --set controller.publishService.enabled=true \
                                  --set controller.scope.enabled=false
                            fi
                        '''
                    }
                }
            }
        }


        stage('Wait for LoadBalancer & Update Values') {
            steps {
                script {
                    withAWS(credentials: 'aws-creds', region: REGION) {
                        echo '‚è≥ Waiting for LoadBalancer hostname...'
                        timeout(time: 8, unit: 'MINUTES') {
                            waitUntil {
                                def lb = sh(
                                    script: "kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].hostname}{.status.loadBalancer.ingress[0].ip}'",
                                    returnStdout: true
                                ).trim()
                                echo "LoadBalancer address: ${lb}"
                                return lb != ''
                            }
                       }

                        echo 'üîç Fetching external hostname from NGINX Ingress...'
                        def albDns = sh(
                            script: "kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'",
                            returnStdout: true
                        ).trim()

                        if (!albDns) {
                            echo "Hostname not found, trying IP..."
                            albDns = sh(
                                script: "kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}'",
                                returnStdout: true
                            ).trim()
                        }

                        if (!albDns) {
                            error "‚ùå External hostname/IP not found for ingress-nginx-controller service!"
                        }

                        env.ALB_DNS = albDns
                        echo "‚û°Ô∏è LoadBalancer external hostname/IP: ${albDns}"

                        // Replace placeholders in values files
                        sh "sed -i 's|__ALB_DNS__|${albDns}|g' Prometheus/prometheus-values.yaml "

                        // Commit updated values files to repo
                        sh """
                            git config user.email "jenkins-ci@jenkins.com"
                            git config user.name "jenkins-CI"
                            git add Prometheus/prometheus-values.yaml 
                            git commit -m "Update ALB DNS to ${albDns}" || echo "No changes to commit"
                            git push origin HEAD:master || true
                        """

                        sh """
                            helm upgrade argo-cd argo/argo-cd \
                              --namespace argocd \
                              -f ArgoCD-config/argocd-values.yaml
                        """
                    }
                }
            }
        }

        stage('Install/Upgrade Prometheus') {
            steps {
                script {
                    withAWS(credentials: 'aws-creds', region: REGION) {
                            // Install or upgrade Prometheus stack (includes Alertmanager UI)
                            sh '''
                                helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
                                helm repo update

                                if helm ls -n monitoring | grep -q prometheus; then
                                    echo "üîÑ Upgrading existing Prometheus release..."
                                    helm upgrade prometheus prometheus-community/kube-prometheus-stack \
                                        --namespace monitoring \
                                        -f Prometheus/prometheus-values.yaml \
                                        --set ingress.enabled=false \
                                        --set installCRDs=true
                                else
                                    echo "üöÄ Installing new Prometheus release..."
                                    helm install prometheus prometheus-community/kube-prometheus-stack \
                                        --namespace monitoring --create-namespace \
                                        -f Prometheus/prometheus-values.yaml \
                                        --set ingress.enabled=false \
                                        --set installCRDs=true 
                                fi
                            '''
                    }
                }
            }
        }

        stage('Wait for Grafana Pod & Apply monitoring Ingress') {
            steps {
                script {
                    withAWS(credentials: 'aws-creds', region: REGION) {
                        echo '‚è≥ Waiting for Grafana pod...'
                        timeout(time: 8, unit: 'MINUTES') {
                            waitUntil {
                                sh(script: "kubectl get pods -n monitoring -l app.kubernetes.io/name=grafana --field-selector=status.phase=Running | grep grafana", returnStatus: true) == 0
                            }
                        }
                        echo '‚úÖ Grafana running.'
                        echo 'üöÄ Applying unified Ingress...'
                        sh 'kubectl apply -f ${MONITOR_INGRESS_FILE}'

                        sh 'kubectl apply -f ${ARGOCD_INGRESS_FILE}'
                    }
                }
            }
        }

        stage('Wait for Prometheus & Alertmanager Pods') {
            steps {
                script {
                    withAWS(credentials: 'aws-creds', region: REGION) {
                        echo "‚è≥ Waiting for Prometheus pod..."
                        timeout(time: 6, unit: 'MINUTES') {
                            waitUntil {
                                sh(script: "kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus -o jsonpath='{.items[*].status.phase}' | grep Running", returnStatus: true) == 0
                            }
                        }
                        echo "‚è≥ Waiting for Alertmanager pod..."
                        timeout(time: 6, unit: 'MINUTES') {
                            waitUntil {
                                sh(script: "kubectl get pods -n monitoring -l app.kubernetes.io/name=alertmanager -o jsonpath='{.items[*].status.phase}' | grep Running", returnStatus: true) == 0
                            }
                        }

                        echo "‚úÖ Prometheus & Alertmanager running."
                    }
                }
            }
        }

        stage('Capture Cluster Configurations') {
            steps {
                script {
                    echo "üìù Capturing cluster configurations and errors using script"
                    sh '''
                        # Run the script from the Scripts directory
                        bash Scripts/capture-configs.sh

                        bash Scripts/collect-error.sh
                    '''
                    echo "‚úÖ Cluster configurations and errors captured successfully."
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Post-deployment setup completed successfully.'
        }
        failure {
            echo '‚ùå Post-deployment setup failed. Check logs for details.'
            script {
                echo 'üßπ Cleaning up Docker images, k8 objects at all namespaces, secrets etc...'
                sh '''
                    kubectl delete deployments,services,pods,ingress -n default --ignore-not-found=true
                    kubectl delete deployments,services,pods,ingress -n monitoring --ignore-not-found=true
                    kubectl delete deployments,services,pods,ingress -n k8ui --ignore-not-found=true
                    kubectl delete svc ingress-nginx-controller -n ingress-nginx || true
                    kubectl delete secret grafana-admin-password -n monitoring --ignore-not-found=true
                    kubectl delete secret db-credentials -n default --ignore-not-found=true
                    helm uninstall ingress-nginx -n ingress-nginx || true
                '''
            }
        }
    }
}
