pipeline {
    agent any

    environment {
        AWS_CREDENTIALS_ID = 'aws-creds'
        CLUSTER_NAME = 'app-clus'
        REGION = 'us-west-2'
    }

    stages {
        stage('Configure AWS CLI') {
            steps {
                script {
                    withCredentials([aws(credentialsId: 'aws-creds', var: 'AWS_CREDENTIALS')]) {
                        echo "‚öôÔ∏è Configuring AWS CLI using Jenkins credentials..."
                        sh """
                            # Configure AWS CLI using credentials from Jenkins
                            # AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY are automatically set by withCredentials block
                            aws configure set aws_access_key_id \$AWS_ACCESS_KEY_ID
                            aws configure set aws_secret_access_key \$AWS_SECRET_ACCESS_KEY
                            aws configure set default.region ${REGION}
                            echo "‚úÖ AWS CLI configured."
                        """
                    }
                }
            }
        }

        stage('Check for Existing EKS Cluster') {
            steps {
                script {
                    echo "üîç Checking if EKS cluster '${CLUSTER_NAME}' already exists..."
                    withAWS(credentials: "${AWS_CREDENTIALS_ID}", region: "${REGION}") {
                        def clusterStatus = sh(
                            script: """
                                aws eks describe-cluster \
                                    --name ${CLUSTER_NAME} \
                                    --region ${REGION} \
                                    --query 'cluster.status' \
                                    --output text || echo "NOTFOUND"
                            """,
                            returnStdout: true
                        ).trim()

                        if (clusterStatus == "ACTIVE" || clusterStatus == "CREATING") {
                            echo "‚úÖ Cluster '${CLUSTER_NAME}' already exists with status: ${clusterStatus}"
                            currentBuild.result = 'SUCCESS'
                            return
                        } else {
                            echo "üöÄ Cluster not found. Proceeding to creation..."
                        }
                    }
                }
            }
        }

        stage('Create EKS Cluster') {
            when {
                expression {
                    currentBuild.result != 'SUCCESS'
                }
            }
            steps {
                script {
                    withAWS(credentials: "${AWS_CREDENTIALS_ID}", region: "${REGION}") {
                        echo "üöÄ Creating new EKS cluster from configuration file..."
                        sh """
                            set -e
                            eksctl create cluster -f Scripts/cluster-config.yaml
                        """
                    }
                }
            }
        }

        stage('Update kubeconfig') {
            steps {
                script {
                    echo "üîÑ Updating kubeconfig for EKS cluster '${CLUSTER_NAME}'..."
                    withAWS(credentials: "${AWS_CREDENTIALS_ID}", region: "${REGION}") {
                        sh """
                            aws eks update-kubeconfig \\
                            --name ${CLUSTER_NAME} \\
                            --region ${REGION} \\
                            --alias ${CLUSTER_NAME}
                        """
                        echo '‚úÖ kubeconfig updated successfully.'

                        echo '‚úÖ Varifying connectivity.'

                        sh "kubectl get nodes"
                    }
                }
            }
        }

        stage('Wait for Node Readiness') {
            steps {
                script {
                    withAWS(credentials: "${AWS_CREDENTIALS_ID}", region: "${REGION}") {
                    echo "‚è≥ Waiting for EKS nodes to become ready..."
                        timeout(time: 10, unit: 'MINUTES') {
                            waitUntil {
                                def readyNodes = sh(
                                    script: "kubectl get nodes --no-headers | grep 'Ready' | wc -l",
                                    returnStdout: true
                                ).trim().toInteger()
                                echo "Nodes Ready: ${readyNodes}"
                                return readyNodes > 0
                            }
                        }
                    }
              
                    echo "‚úÖ EKS nodes are ready."
                }
            }
        }

        stage('Install ArgoCD') {
            steps {
                script {
                    withAWS(credentials: 'aws-creds', region: REGION) {
                        echo "üöÄ Installing ArgoCD using Helm..."
                        sh """
                            # Check if namespace 'argocd' exists
                            if ! kubectl get namespace argocd >/dev/null 2>&1; then
                                echo "üì¶ Creating 'argocd' namespace..."
                                kubectl create namespace argocd
                            else
                                echo "‚úÖ Namespace 'argocd' already exists. Skipping creation."
                            fi

                            # Add and update ArgoCD Helm repo
                            helm repo add argo https://argoproj.github.io/argo-helm || true
                            helm repo update

                            # Check if ArgoCD is already installed
                            if helm status argocd -n argocd >/dev/null 2>&1; then
                                echo "‚úÖ ArgoCD is already installed in namespace 'argocd'. Skipping Helm install."
                            else
                               echo "üöÄ Installing ArgoCD with Helm..."
                                helm install argocd argo/argo-cd \\
                                    --namespace argocd \\
                                    --set server.service.type=ClusterIP \\
                                    --set installCRDs=true
                            fi
                        """
                    }
                }
            }
        }

        stage('Deploy ArgoCD Ingress') {
            steps {
                script {
                    withCredentials([aws(credentialsId: 'aws-creds', var: 'AWS_CREDENTIALS')]) {
                        echo 'üöÄ Deploying argocd-ingress.yaml...'
                        sh 'kubectl apply -f K8s/Ingress/argocd-ingress.yaml'
                    }
                }
            }
        }

        stage('Apply ArgoCD Application File') {
            steps {
                script {
                    withAWS(credentials: 'aws-creds', region: REGION) {
                        echo "checking for argocd CRD"
                        sh '''
                            if ! kubectl get crd applications.argoproj.io > /dev/null 2>&1; then
                            echo "‚ùå ArgoCD CRD missing!"
                            exit 1
                            fi
                        '''
                        echo "üöÄ Applying ArgoCD Application manifest..."
                        sh '''
                            # Apply the ArgoCD Application manifest for your deployments
                            kubectl apply -f ArgoCD-config/argo-app-main.yaml -n argocd --validate=false
                    
                            # Apply the ArgoCD Application manifest for your application's ingress
                            kubectl apply -f ArgoCD-config/argo-app-ingress.yaml -n argocd --validate=false
                        '''
                        echo "‚úÖ ArgoCD Application has been applied."
                    }
                }
            }
        }

        stage('Create Kubernetes DB Secret') {
            steps {
                withCredentials([file(credentialsId: 'db-secrets-file', variable: 'DB_SECRETS_FILE')]) {
                    script {
                        withAWS(credentials: 'aws-creds', region: REGION) {
                            echo "üîê Creating Kubernetes secret for database credentials..."
                            sh """
                                kubectl create secret generic db-credentials \
                                  --from-env-file=${DB_SECRETS_FILE} \
                                  -n default --dry-run=client -o yaml | kubectl apply -f -
                            """
                        }
                    }
               }
            }
        }
    }

    post {
        success {
            echo '‚úÖ EKS cluster creation, ArgoCD installation, and application deployment completed (or already existed).'
        }
        failure {
            echo '‚ùå EKS cluster creation or ArgoCD installation job failed.'
        }
    }
}




